import requests
from bs4 import BeautifulSoup
from PyQt5.QtCore import QObject, pyqtSignal
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service as ChromeService


class VulnerabilityScanner(QObject):
    progress_signal = pyqtSignal(int)

    def __init__(self, url, log_callback):
        super().__init__()
        self.url = url
        self.log = log_callback
        self.num_checks = 5
        self.detailed_logs = []
        self.summaries = []
        self.success = True  # Initialize success flag

    def scan(self):
        completed_checks = 0

        try:
            result = self.check_sql_injection()
            self.detailed_logs.append(result)
            self.summaries.append(self.summarize_result(result))
        except Exception as e:
            error_message = f"Error during SQL Injection test: {e}"
            self.detailed_logs.append(error_message)
            self.summaries.append("SQL Injection test: Error")
            self.success = False
        completed_checks += 1
        self.progress_signal.emit(self.calculate_progress(completed_checks))

        try:
            result = self.check_xss()
            self.detailed_logs.append(result)
            self.summaries.append(self.summarize_result(result))
        except Exception as e:
            error_message = f"Error during XSS test: {e}"
            self.detailed_logs.append(error_message)
            self.summaries.append("XSS test: Error")
            self.success = False
        completed_checks += 1
        self.progress_signal.emit(self.calculate_progress(completed_checks))

        try:
            result = self.check_csrf()
            self.detailed_logs.append(result)
            self.summaries.append(self.summarize_result(result))
        except Exception as e:
            error_message = f"Error during CSRF test: {e}"
            self.detailed_logs.append(error_message)
            self.summaries.append("CSRF test: Error")
            self.success = False
        completed_checks += 1
        self.progress_signal.emit(self.calculate_progress(completed_checks))

        try:
            result = self.check_directory_traversal()
            self.detailed_logs.append(result)
            self.summaries.append(self.summarize_result(result))
        except Exception as e:
            error_message = f"Error during Directory Traversal test: {e}"
            self.detailed_logs.append(error_message)
            self.summaries.append("Directory Traversal test: Error")
            self.success = False
        completed_checks += 1
        self.progress_signal.emit(self.calculate_progress(completed_checks))

        try:
            result = self.check_version_based_vulnerabilities()
            self.detailed_logs.append(result)
            self.summaries.append(self.summarize_result(result))
        except Exception as e:
            error_message = f"Error during version-based vulnerability test: {e}"
            self.detailed_logs.append(error_message)
            self.summaries.append("Version-based vulnerability test: Error")
            self.success = False
        completed_checks += 1
        self.progress_signal.emit(self.calculate_progress(completed_checks))

        # Append overall success/failure status to summaries
        status = "Scan Successful" if self.success else "Scan Failed"
        self.summaries.append(status)
        
        return "\n".join(self.summaries)

    def calculate_progress(self, completed_checks):
        return int((completed_checks / self.num_checks) * 100)

    def check_sql_injection(self):
        payloads = [
            "' OR '1'='1",
            "' AND '1'='1",
            "' OR 'x'='x",
            "' OR 1=1 --",
            "' OR 1=1 /*",
            "' OR 'a'='a",
        ]
        results = ["SQL Injection Test Results:"]

        for payload in payloads:
            test_url = f"{self.url}?id={payload}"
            try:
                response = requests.get(test_url, timeout=10)
                self.log(f"SQL Injection test URL: {test_url}")
                self.log(f"Response Code: {response.status_code}")
                self.log(f"Response Time: {response.elapsed.total_seconds()} seconds")
                self.log(f"Response Length: {len(response.text)} bytes")
                if "error" in response.text.lower() or response.status_code == 500:
                    results.append(f"Potential SQL Injection vulnerability detected with payload: {payload}")
            except requests.RequestException as e:
                results.append(f"Error during SQL Injection test with payload {payload}: {e}")

        return "\n".join(results)

    def check_xss(self):
        options = Options()
        options.headless = True
        driver = webdriver.Chrome(options=options, service=ChromeService())

        payloads = [
            "<script>alert('XSS')</script>",
            "'\"><img src=x onerror=alert('XSS')>",
            "<svg/onload=alert('XSS')>",
        ]
        results = ["XSS Test Results:"]

        for payload in payloads:
            test_url = f"{self.url}?q={payload}"
            try:
                driver.get(test_url)
                alert = driver.switch_to.alert
                alert.accept()
                results.append(f"Potential XSS vulnerability detected with payload: {payload}")
            except Exception as e:
                self.log(f"No alert found for payload {payload}: {e}")

        driver.quit()
        return "\n".join(results)

    def check_csrf(self):
        results = ["CSRF Test Results:"]

        try:
            response = requests.get(self.url, timeout=10)
            self.log(f"CSRF test URL: {self.url}")
            self.log(f"Response Code: {response.status_code}")
            self.log(f"Response Time: {response.elapsed.total_seconds()} seconds")
            self.log(f"Response Length: {len(response.text)} bytes")

            if "csrf" not in response.text.lower():
                results.append("Potential CSRF vulnerability detected: No CSRF tokens found.")
        except requests.RequestException as e:
            results.append(f"Error during CSRF test: {e}")

        return "\n".join(results)

    def check_directory_traversal(self):
        payloads = [
            "../",
            "..\\",
            "/etc/passwd",
            "C:\\Windows\\System32",
        ]
        results = ["Directory Traversal Test Results:"]

        for payload in payloads:
            test_url = f"{self.url}/{payload}"
            try:
                response = requests.get(test_url, timeout=10)
                self.log(f"Directory Traversal test URL: {test_url}")
                self.log(f"Response Code: {response.status_code}")
                self.log(f"Response Time: {response.elapsed.total_seconds()} seconds")
                self.log(f"Response Length: {len(response.text)} bytes")
                if response.status_code == 200:
                    results.append(f"Potential Directory Traversal vulnerability detected with payload: {payload}")
            except requests.RequestException as e:
                results.append(f"Error during Directory Traversal test with payload {payload}: {e}")

        return "\n".join(results)

    def check_version_based_vulnerabilities(self):
        results = ["Version-based Vulnerability Test Results:"]

        try:
            response = requests.get(self.url, timeout=10)
            self.log(f"Version-based vulnerability test URL: {self.url}")
            self.log(f"Response Code: {response.status_code}")
            self.log(f"Response Time: {response.elapsed.total_seconds()} seconds")
            self.log(f"Response Length: {len(response.text)} bytes")

            soup = BeautifulSoup(response.text, 'html.parser')
            meta_generator = soup.find('meta', {'name': 'generator'})

            if meta_generator:
                generator = meta_generator.get('content', '')
                if generator:
                    self.log(f"Detected generator: {generator}")
                    results.append(f"Potential version-based vulnerabilities detected: Generator tag found - {generator}")

        except requests.RequestException as e:
            results.append(f"Error during version-based vulnerability test: {e}")

        return "\n".join(results)

    def summarize_result(self, result):
        summary = []
        lines = result.split("\n")
        for line in lines:
            if "vulnerability detected" in line or "No CSRF tokens found." in line:
                summary.append(line)
        return "\n".join(summary)

    def get_detailed_logs(self):
        return "\n".join(self.detailed_logs)

    def get_summaries(self):
        return "\n".join(self.summaries)
